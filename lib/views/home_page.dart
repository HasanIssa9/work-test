import 'package:firebase_database/firebase_database.dart';import 'package:flutter/foundation.dart';import 'package:flutter/material.dart';import 'package:intl/intl.dart' hide TextDirection;import 'package:work_app/extensions/dropdown_input.dart';import 'package:work_app/extensions/text_input.dart';import 'package:work_app/views/students_page.dart';class HomePage extends StatefulWidget {  const HomePage({super.key});  @override  State<HomePage> createState() => _HomePageState();}class _HomePageState extends State<HomePage> {  final dbstd = FirebaseDatabase.instance.ref().child('data');  final _formKey = GlobalKey<FormState>();  final TextEditingController number = TextEditingController();  final TextEditingController name = TextEditingController();  String? couValue = '';  String? empValue = '';  String? speValue = '';  String? selectedDate = DateFormat('y-MM-d').format(DateTime.now());  Future<bool> checkIfItemExists(String itemKey) async {    var snapshot = await dbstd.child(itemKey).once();    if (snapshot.snapshot.value != null) {      return true;    }    return false;  }  Future<String?> findItemKey(String searchValue) async {    var snapshot = await dbstd.orderByChild('id').equalTo(searchValue).once();    if (snapshot.snapshot.value != null) {      Map<dynamic, dynamic> values = snapshot.snapshot.value as Map;      String? key = values.keys.first;      return key;    }    return null;  }  @override  Widget build(BuildContext context) {    return Directionality(      textDirection: TextDirection.rtl,      child: Scaffold(        appBar: (!kIsWeb)            ? AppBar(                leading: IconButton(                  onPressed: () {                    Navigator.push(                      context,                      MaterialPageRoute(                          builder: (context) => const StudentsPage()),                    );                  },                  icon: const Icon(Icons.group),                ),                elevation: 0,              )            : null,        body: Center(          child: Container(            padding: (kIsWeb) ? const EdgeInsets.all(20) : null,            margin: (kIsWeb) ? const EdgeInsets.all(20) : null,            width: (kIsWeb) ? MediaQuery.sizeOf(context).width * 0.75 : null,            decoration: (kIsWeb)                ? BoxDecoration(                    borderRadius: BorderRadius.circular(16),                    border: Border.all(color: Colors.lightGreen, width: 6))                : null,            child: Row(              children: [                Expanded(                    child: Column(                  children: [                    const Center(                        child: Text(                      'سجل أستلام كشوف \n   الطلبة الوافدين',                      style:                          TextStyle(fontWeight: FontWeight.bold, fontSize: 25),                    )),                    Expanded(                      child: SingleChildScrollView(                        child: Container(                          height: MediaQuery.sizeOf(context).height * 0.75,                          padding: const EdgeInsets.symmetric(horizontal: 14),                          child: Form(                            key: _formKey,                            child: Column(                              mainAxisAlignment: MainAxisAlignment.spaceEvenly,                              crossAxisAlignment: CrossAxisAlignment.start,                              children: [                                TextInput(                                  hintName: 'تسلسل: ',                                  isNumber: true,                                  controller: number,                                ),                                TextInput(                                  hintName: 'أسم الطالب: ',                                  controller: name,                                ),                                DropdownInput(                                  isCou: true,                                  onChanged: (value) {                                    couValue = value;                                  },                                ),                                DropdownInput(                                  onChanged: (value) {                                    speValue = value;                                  },                                ),                                DropdownInput(                                    isEmp: true,                                    onChanged: (value) {                                      empValue = value;                                    }),                                Row(                                  children: [                                    const Icon(                                      Icons.date_range_rounded,                                      color: Colors.lightGreen,                                    ),                                    const SizedBox(                                      width: 19,                                    ),                                    Container(                                      height: 60,                                      width: (!kIsWeb)                                          ? MediaQuery.sizeOf(context).width *                                              0.496                                          : MediaQuery.sizeOf(context).width *                                              0.25,                                      padding: const EdgeInsets.symmetric(                                          horizontal: 12, vertical: 15),                                      decoration: BoxDecoration(                                        border: Border.all(                                          color: Colors.lightGreen,                                          width: 2,                                        ),                                        borderRadius: BorderRadius.circular(16),                                      ),                                      child: GestureDetector(                                        onTap: () async {                                          try {                                            final DateTime? picked =                                                await showDatePicker(                                                    context: context,                                                    initialDate: DateTime.now(),                                                    firstDate: DateTime.now()                                                        .subtract(                                                            const Duration(                                                                days: 90)),                                                    lastDate: DateTime.now()                                                        .add(const Duration(                                                            days: 90)));                                            if (picked != null &&                                                picked != selectedDate) {                                              setState(() {                                                selectedDate =                                                    DateFormat('y-MM-d')                                                        .format(picked);                                              });                                            }                                          } catch (e) {                                            print('Error parsing date: $e');                                          }                                        },                                        child: Text(                                          selectedDate!,                                          style: const TextStyle(                                            fontSize: 18,                                          ),                                        ),                                      ),                                    ),                                  ],                                ),                                const SizedBox(                                  height: 25,                                ),                                Center(                                  child: ElevatedButton.icon(                                    style: ElevatedButton.styleFrom(                                        backgroundColor: Colors.cyan,                                        padding: const EdgeInsets.symmetric(                                            horizontal: 28, vertical: 8),                                        foregroundColor: Colors.black,                                        textStyle: const TextStyle(                                            fontWeight: FontWeight.bold,                                            fontSize: 22)),                                    onPressed: () async {                                      if (_formKey.currentState!.validate()) {                                        String? key =                                            await findItemKey(number.text);                                        bool isExist =                                            await checkIfItemExists(key ?? '');                                        if (isExist &&                                            key != '' &&                                            key != null) {                                          buildShowDialog(context, key);                                        } else {                                          dbstd.push().set({                                            'conName': couValue,                                            'date': selectedDate,                                            'empName': empValue,                                            'id': number.text,                                            'speName': speValue,                                            'stdName': name.text                                          }).asStream();                                          ScaffoldMessenger.of(context)                                              .showSnackBar(                                            snackBar(' تم اضافة الطالب '),                                          );                                          setState(() {                                            number.clear();                                            name.clear();                                          });                                        }                                      }                                    },                                    icon: const Icon(Icons.add),                                    label: const Text('اضافة طالب او تحديث'),                                  ),                                )                              ],                            ),                          ),                        ),                      ),                    ),                  ],                )),                (kIsWeb)                    ? const VerticalDivider(                        color: Colors.lightGreen,                        thickness: 6,                      )                    : Container(),                (kIsWeb) ? const Expanded(child: StudentsPage()) : Container(),              ],            ),          ),        ),      ),    );  }  snackBar(String text) => SnackBar(        backgroundColor: Colors.transparent,        elevation: 0,        dismissDirection: DismissDirection.none,        padding: EdgeInsets.zero,        margin: const EdgeInsets.only(bottom: 15),        behavior: SnackBarBehavior.floating,        duration: const Duration(seconds: 3),        content: Center(          child: Container(            margin: const EdgeInsets.symmetric(vertical: 130),            padding: const EdgeInsets.symmetric(vertical: 15, horizontal: 20),            decoration: BoxDecoration(              borderRadius: BorderRadius.circular(50),              color: Colors.blueAccent,            ),            child: Text(              text,              style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 18),            ),          ),        ),      );  Future<void> buildShowDialog(BuildContext context, String key) {    return showDialog<void>(      context: context,      builder: (BuildContext ctx) {        return Directionality(          textDirection: TextDirection.rtl,          child: AlertDialog(            title: const Text("تحديث البيانات"),            content: const Text("هل تريد تحديث بيانات الطالب؟"),            actions: [              TextButton(                child: const Text("الغاء"),                onPressed: () {                  ScaffoldMessenger.of(context).showSnackBar(                      snackBar(' هذا الطالب موجود ولاحاجة لتحديث '));                  setState(() {                    number.clear();                    name.clear();                  });                  Navigator.of(context).pop();                  return;                },              ),              TextButton(                child: const Text("تحديث"),                onPressed: () {                  dbstd.child(key).update({                    'conName': couValue,                    'date': selectedDate,                    'empName': empValue,                    'id': number.text,                    'speName': speValue,                    'stdName': name.text                  }).asStream();                  ScaffoldMessenger.of(context).showSnackBar(                    snackBar(' تم تحديث بيانات الطالب '),                  );                  setState(() {                    number.clear();                    name.clear();                  });                  Navigator.of(context).pop();                },              ),            ],          ),        );      },    );  }}